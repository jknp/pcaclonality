---
title: "Clonality in PCa primary tumors and lymph node metastases"
output: html_notebook
---
Published as: Frequent clonal relations between metastases and non-index prostate cancer lesions 
Jeroen Kneppers, Oscar Krijgsman, Monique Melis, Jeroen de Jong, Daniel S. Peeper, Elise Bekers, Henk G. van der Poel, Wilbert Zwart, Andries M. Bergman 
Published January 24, 2019 
Citation Information: JCI Insight. 2019;4(2):e124756. https://doi.org/10.1172/jci.insight.124756.


Special thanks to Oscar Krijgsman for providing initial bulk analysis, heatmap scripts and helpful advice.

### Introduction
This is documentation providing a comprehensive outline of produced data and figures in this project.

### Contents

0. Setup
1. QDNAseq processing of LC-WGS (OK code)
2. CGHcall processing (OK)
3. Patient CN heatmaps 
    + Correlation heatmaps
4. Overview CN heatmaps
    + Topbar annotation
5. Zoomed-in CN heatmaps
    + Topbar annotation
6. Clonality analysis
    + 6.1 Density plot
    + 6.2 Boxplot
    + 6.3 Area under density
7. CopywriteR for ChIP

### 0. Setup
Original study was conducted in R version 3.4

```{r setup, echo = T}
library(CGHcall)
library(QDNAseq)
library(Clonality)

path = "D:/D Projects/201707-02 Primary PCa vs Lymph node metastases/OKData/"
```

### 1. QDNAseq processing of LC-WGS
Requires package QDNAseq, code counts low-coverage whole genome sequencing data reads in arbitrary bins of 30kb to deduce whether there are copy number alternations (gains or losses) for each patient in the 30 patient cohort.

```{r QDNAseq} 
setwd(path)

bins <- getBinAnnotations(binSize=30)
readCounts <- binReadCounts(bins)

readCountsFiltered<- applyFilters(readCounts, residual=T, blacklist=T, chromosomes=NA)
readCountsFiltered <- estimateCorrection(readCountsFiltered)

noisePlot(readCountsFiltered)
copyNumbers<-correctBins(readCountsFiltered) 

copyNumbersNormalized<-normalizeBins(copyNumbers)
copyNumbersSmooth<-smoothOutlierBins(copyNumbersNormalized)

plot(copyNumbersSmooth)

exportBins(copyNumbersSmooth, file="copyNumbers_Prostate_30Kb.txt")
exportBins(copyNumbersSmooth, file="Prostate_30Kb.igv", format="igv")
```

### 2. CHGcall processing
CGHcall reads the QDNAseq data and normalizes, smoothens and segments the QDNAseq data. There is also a segment normalization step which further normalizes the inherently noisy signal before storing it in a CGHcall calls object containing all CNA information.

```{r CGHcall} 
setwd(path)
Data <- read.table(file="copyNumbers_Prostate_30Kb.txt", sep = "\t", header=T)

raw <- make_cghRaw(Data)
prep <- preprocess(raw, maxmiss = 0, nchrom = 22) 
nor <-  normalize(prep,method = "median", smoothOutliers = TRUE)

seg <-  segmentData(nor, method = "DNAcopy",nperm=2000,undo.splits="sdundo",
                    min.width=5,undo.SD=2, clen=25, relSDlong=5)

segnorm <- postsegnormalize(seg,inter=c(-0.4,0.4))
listcalls <- CGHcall(segnorm,nclass=5,robustsig="yes",cellularity=1,ncpus=12)
calls <- ExpandCGHcall(listcalls,segnorm, divide=5, memeff=FALSE)
save(calls, file="Zwart_Prostate.Rdata")
```

### 3. Patient CN heatmaps
The following loop takes the calls from a certain patient through indexing by the sample annotation file.
It then plots copy number gains and losses per chromosome in an overviewplot, which is a script written by OK.

```{r Plotting heatmaps per patient}
setwd(path)
load("Zwart_Prostate.Rdata")  

Index_samples <- match(paste0("X",Sample_ann[,1]), colnames(calls))
calls <- calls[,Index_samples]

## Double check to see if sorted correctly
table(colnames(calls) == paste0("X",Sample_ann[,1]))

#Plotting loop of CNA per patients
for (i in 1:length(unique(Sample_ann$Patient))){
	IndexSelectedSamples <- which(Sample_ann[,4] == i)
	
	pdf(file=paste0("Patient_",i,".pdf"), width=7, height=4)
	source("/Additional_Scripts/overviewPlot_MIN-MAX_Xchromosome_correct.R")
	overviewPlot(calls[,IndexSelectedSamples], scaling=0.6)
	
	dev.off()
}
```

#### 3.1 Correlation heatmaps
The following code was used to plot pearson correlations of different tumor foci found in a single patient.

In this case, patient 11 had samples taken from different areas within the same focus(*), but also had many different foci and a lymph node metastasis. The plot in figure 1E shows that the index focus P1 is largely homogeneous in CNAs, while not correlating with the lymph node metastasis (N) nor the other primary loci (P2-P5).

```{r Plotting correlation heatmap of tumor CNAs of a single patient}
PatientSelect = 11 
IndexSelectedSamples <- numeric(0)


for(i in 1:length(PatientSelect)){
  #Firstloop is if multiple patients are given in PatientSelect
  for (j in 1:length(Sample_annotation$Patient)){
    Selection <- which(Sample_annotation[,4] == PatientSelect[i])
    }
  IndexSelectedSamples <- c(IndexSelectedSamples, Selection)
  }

#Pearson correlation
corpat <- cor(segmented(calls[,IndexSelectedSamples]))

#plotting and saving
pdf(file= "heatmap_p11.pdf", width=4*480, height=2.6*480, res=200)
heatmap3(corpat, method = "ward.D2" , breaks = seq(0, 1, length.out = 1025), 
         scale = "none",showColDendro = F, labRow = Sample_ann$Pair_No[IndexSelectedSamples], 
         labCol = Sample_ann$Pair_No[IndexSelectedSamples])

dev.off()
```

### 4. Overview CNA heatmaps
Code used to generate the large overview plot showing genome-wide CNA in the entire 30 patient cohort.
Insets were generated by zooming in at PCa specific loci.
Topbar containing annotation was generated separately and further edited in Adobe illustrator.

```{r Overivew CNA heatmap}
#Initialization
Sample_ann <- read.table(file=paste0(path,"CFMPB293_key.txt"), 
                         sep="\t", header=T, stringsAsFactors = F)
Sample_ann_V2 <- read.table(file=paste0(path,"CFMPB293_keyV3.txt"), 
                            sep="\t", header=T, stringsAsFactors = F)

NVcalls <-calls[,which(Sample_ann_V2$Neo =="0")]
Sample_ann_NV <- Sample_ann_V2[!(Sample_ann_V2$Neo== 1),]
table(colnames(NVcalls)==paste0("X",Sample_ann_NV[,1]))

source("/Additional_Scripts/overviewPlot_MIN-MAX_Xchromosome_correct.R")
overviewPlot(NVcalls, scaling =1)

#Alternative matching
#Index_samples<-match(paste0("X",Sample_ann[,1]), colnames(calls))
#calls<-calls[,Index_samples]
#table(colnames(calls)==paste0("X",Sample_ann[,1]))
```

```{r Insets zoomed on specific loci}
#Zoomed AR Initialization, Sel contains genomic coordinates in c(chr,start,end) format
Sel <- c(23, 65000000, 68000000) #Also plotted inset zooms for MYC and TMPRSS2 locations
Ind <- which(Sample_ann_NV$Dupli_P == 0)
ChrRange <- which(chromosomes(NVcalls)== Sel[1] & bpstart(NVcalls)< Sel[3] & bpend(NVcalls) > Sel[2])

source("/Additional_Scripts/overviewPlot_MIN-MAX_Xchromosome_correct.R")
overviewPlot(NVcalls[ChrRange, Ind], scaling=1) +
  title(main = paste0("Chromosome ", Sel[1], " ", (Sel[2]/1000), " kb to ", (Sel[3]/1000), " kb"))

#Sorted ChrRange over random:
#ChrRange_sorted <- rank(-(NVcalls[ChrRange, Ind]))
```

```{r sorting the overviewplot by specific clinical parameters}
#Tumor type sort
overviewPlot(NVcalls[,which(Sample_ann_NV$Tumor=="P")])
overviewPlot(NVcalls[,which(Sample_ann_NV$Tumor=="LN")])
overviewPlot(NVcalls[,which(Sample_ann_NV$Dupli_P== 0)])

#Gleason sort only
NVcalls_sort <- NVcalls[,order(Sample_ann_NV$Gleason, decreasing = T)]
Sample_ann_NV_sort <- Sample_ann_NV[order(Sample_ann_NV$Gleason, decreasing = T),]
table(colnames(NVcalls_sort)==paste0("X",Sample_ann_NV_sort[,1]))

#Tumor type sort only
NVcalls_sort <- NVcalls[,order(Sample_ann_NV$Tumor, decreasing = F)]
Sample_ann_NV_sort <- Sample_ann_NV[order(Sample_ann_NV$Tumor, decreasing = F),]
table(colnames(NVcalls_sort)==paste0("X",Sample_ann_NV_sort[,1]))
Ind <- which(Sample_ann_NV$Neo == 0)

#Combination Gleason & Tumor type
NVcalls_sort <- NVcalls[,order(Sample_ann_NV$Gleason, decreasing = T)]
Sample_ann_NV_sort <- Sample_ann_NV[order(Sample_ann_NV$Gleason, decreasing = T),]
NVcalls_sort <- NVcalls_sort[,order(Sample_ann_NV$Tumor, decreasing = F)]
Sample_ann_NV_sort <- Sample_ann_NV_sort[order(Sample_ann_NV$Tumor, decreasing = F),]

table(colnames(NVcalls_sort)==paste0("X",Sample_ann_NV_sort[,1]))
Ind <- which(Sample_ann_NV$Neo == 0)

overviewPlot(NVcalls_sort[ChrRange, Ind], scaling=1) +
  title(main = paste0("Chromosome ", Sel[1], " ", (Sel[2]/1000), " kb to ", (Sel[3]/1000), " kb"))
```
